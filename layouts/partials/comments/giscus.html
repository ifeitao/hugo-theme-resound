{{ $giscusLight := .Site.Params.giscus.theme_light | default "light" }}
{{ $giscusDark := .Site.Params.giscus.theme_dark | default "dark_dimmed" }}

<script>
// Determine initial theme before loading giscus
(function() {
  // Check localStorage first (same logic as theme toggle)
  const key = 'resound-theme';
  const saved = localStorage.getItem(key);
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  const html = document.documentElement;
  let isDark = false;
  
  // Determine theme based on saved preference or system
  if (saved === 'dark') {
    isDark = true;
  } else if (saved === 'light') {
    isDark = false;
  } else {
    // No saved preference, check data-theme attribute or system
    const manualTheme = html.getAttribute('data-theme');
    if (manualTheme === 'dark') {
      isDark = true;
    } else if (manualTheme === 'light') {
      isDark = false;
    } else {
      isDark = prefersDark;
    }
  }
  
  const initialTheme = isDark ? "{{ $giscusDark }}" : "{{ $giscusLight }}";
  
  console.log('[Giscus Init] Saved theme:', saved, 'isDark:', isDark, 'initialTheme:', initialTheme);
  
  // Store for later use
  window.giscusTheme = {
    light: "{{ $giscusLight }}",
    dark: "{{ $giscusDark }}",
    current: initialTheme
  };
  
  // Inject giscus script with correct initial theme
  const script = document.createElement('script');
  script.src = 'https://giscus.app/client.js';
  script.setAttribute('data-repo', "{{ .Site.Params.giscus.repo }}");
  script.setAttribute('data-repo-id', "{{ .Site.Params.giscus.repo_id }}");
  script.setAttribute('data-category', "{{ .Site.Params.giscus.category }}");
  script.setAttribute('data-category-id', "{{ .Site.Params.giscus.category_id }}");
  script.setAttribute('data-mapping', "{{ .Site.Params.giscus.mapping }}");
  script.setAttribute('data-strict', '0');
  script.setAttribute('data-reactions-enabled', '1');
  script.setAttribute('data-emit-metadata', '0');
  script.setAttribute('data-input-position', 'bottom');
  script.setAttribute('data-theme', initialTheme);
  script.setAttribute('data-lang', "{{ .Site.Params.giscus.lang }}");
  script.setAttribute('crossorigin', 'anonymous');
  script.async = true;
  document.currentScript.parentNode.insertBefore(script, document.currentScript.nextSibling);
})();
</script>

<script>
// Sync giscus theme with site light/dark mode changes
(function () {
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');

  function isSiteDark() {
    const key = 'resound-theme';
    const saved = localStorage.getItem(key);
    const html = document.documentElement;
    const manual = html.getAttribute('data-theme');
    
    console.log('[Giscus Debug] saved:', saved, 'data-theme:', manual, 'prefers-dark:', prefersDark?.matches);
    
    // Check saved preference first
    if (saved === 'dark') return true;
    if (saved === 'light') return false;
    
    // Then check manual attribute
    if (manual === 'dark') return true;
    if (manual === 'light') return false;
    
    // Finally fall back to system preference
    return prefersDark && prefersDark.matches;
  }

  function getGiscusIframe() {
    return document.querySelector('iframe.giscus-frame');
  }

  function setGiscusTheme() {
    const iframe = getGiscusIframe();
    if (!iframe || !window.giscusTheme) {
      console.log('[Giscus Debug] Waiting for iframe or theme config...');
      setTimeout(setGiscusTheme, 200);
      return;
    }
    
    const isDark = isSiteDark();
    const theme = isDark ? window.giscusTheme.dark : window.giscusTheme.light;
    console.log('[Giscus Debug] Site is dark:', isDark, 'Setting theme to:', theme, 'Current:', window.giscusTheme.current);
    
    // Only send message if theme actually changed
    if (theme !== window.giscusTheme.current) {
      try {
        iframe.contentWindow.postMessage({ giscus: { setConfig: { theme } } }, 'https://giscus.app');
        window.giscusTheme.current = theme;
        console.log('[Giscus Debug] Theme updated successfully');
      } catch (e) {
        console.warn('[Giscus Debug] Failed to update theme:', e.message);
      }
    }
  }

  // Listen for theme changes
  if (prefersDark && prefersDark.addEventListener) {
    prefersDark.addEventListener('change', setGiscusTheme);
  }
  const mo = new MutationObserver(function() {
    console.log('[Giscus Debug] data-theme attribute changed');
    setGiscusTheme();
  });
  mo.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme']});
})();
</script>

