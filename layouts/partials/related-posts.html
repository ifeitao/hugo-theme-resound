{{ $related := .Site.RegularPages.Related . | first 5 }}
<div class="related-posts">
  <h3>{{ i18n "relatedPosts" }}</h3>
  <ul class="related-posts-list">
    {{ with $related }}
      {{ range . }}
      <li class="related-post-item">
        <a href="{{ .RelPermalink }}">{{ .Title }}</a>
        <span class="related-post-date">{{ .Date.Format "2006-01-02" }}</span>
      </li>
      {{ end }}
    {{ else }}
      <!-- Fallback: show posts in the same categories when no related posts -->
      {{ $sameCategory := where .Site.RegularPages "Params.categories" "intersect" .Params.categories | symdiff (slice .) | first 5 }}
      {{ with $sameCategory }}
        {{ range . }}
        <li class="related-post-item">
          <a href="{{ .RelPermalink }}">{{ .Title }}</a>
          <span class="related-post-date">{{ .Date.Format "2006-01-02" }}</span>
        </li>
        {{ end }}
      {{ else }}
        <!-- Fallback: show latest posts when category fallback is empty -->
        {{ $recent := .Site.RegularPages.ByDate.Reverse | first 5 }}
        {{ range $recent }}
        <li class="related-post-item">
          <a href="{{ .RelPermalink }}">{{ .Title }}</a>
          <span class="related-post-date">{{ .Date.Format "2006-01-02" }}</span>
        </li>
        {{ end }}
      {{ end }}
    {{ end }}
  </ul>
</div>