<script>
(function(){ // todo list
  lists = document.querySelectorAll('.tdl');
  for (var i = 0; i < lists.length; i++) {
    items = lists[i].getElementsByTagName('li');
    for (var j = 0; j < items.length; j++) {
      items[j].innerHTML = items[j].innerHTML.replace('[ ]', '<input type="checkbox">').replace('[*]', '<input type="checkbox" checked>');
    }
  }
})();

(function(){ // theme toggle
  try {
    var key = 'resound-theme';
    var root = document.documentElement;
    var saved = localStorage.getItem(key);
    
    // Debug: log current state (remove in production)
    console.log('[Theme Debug] localStorage:', saved);
    console.log('[Theme Debug] System prefers dark:', window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
    
    // Initialize theme based on saved preference
    // If no saved preference, don't set data-theme attribute
    // Let CSS media query handle system preference automatically
    if (saved === 'dark' || saved === 'light') {
      root.setAttribute('data-theme', saved);
      console.log('[Theme Debug] Applied saved theme:', saved);
    } else {
      console.log('[Theme Debug] No saved theme, following system preference via CSS');
    }
    // else: no data-theme attribute, CSS @media (prefers-color-scheme) will work
    
    var btn = document.getElementById('theme-toggle');
    if (btn) {
      btn.addEventListener('click', function(e){
        e.preventDefault();
        var current = root.getAttribute('data-theme');
        var next;
        if (current === 'dark') {
          next = 'light';
        } else if (current === 'light') {
          next = '';
        } else {
          next = 'dark';
        }
        if (next) {
          root.setAttribute('data-theme', next);
          localStorage.setItem(key, next);
        } else {
          root.removeAttribute('data-theme');
          localStorage.removeItem(key);
        }
      });
    }
    
    // Listen for system preference changes
    // Note: When user hasn't manually set a preference (no data-theme attribute),
    // CSS @media (prefers-color-scheme) automatically handles the theme
    // No need to set data-theme here
    if (window.matchMedia) {
      var mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
      if (mediaQuery.addEventListener) {
        mediaQuery.addEventListener('change', function(e) {
          // System preference changed
          // If user hasn't manually set a preference, CSS will auto-update
          // No JavaScript action needed
        });
      }
    }
  } catch (err) { /* noop */ }
})();

(function(){  // responsive iframe
  videos = document.querySelectorAll('.video');
  for (var i = 0; i < videos.length; i++) {
    video_frame = document.createElement('iframe');
    video_frame.src = videos[i].innerHTML;
    video_frame.setAttribute('frameborder','0');
    video_frame.setAttribute('allowfullscreen','');
    videos[i].appendChild(video_frame);
  }
})();

(function(){  // if audio in page, load bplayer
    var c = document.getElementsByTagName('audio');
    if (c.length) {
      for (var i = 0; i < c.length; i++) {
        if (!c[i].getAttribute('cover')) { c[i].setAttribute('cover', '{{ "images/music.jpg" | relURL }}'); }
        if (!c[i].getAttribute('color')) { c[i].setAttribute('color', '#e17aa0'); }
        c[i].setAttribute('controls', '');
      }
      var d = document.createElement('style');
      d.innerHTML = "@font-face {font-family: 'iconfont_bplayer';src: url('{{ "extra/bPlayer_font.woff" | relURL }}') format('woff')}";
      document.body.appendChild(d);
      var a = document.createElement('link');
      a.rel = 'stylesheet';
      a.href = '{{ "extra/bplayer.min.css" | relURL }}';
      document.body.appendChild(a);
      var b = document.createElement('script');
      b.src = '{{ "extra/bplayer.min.js" | relURL }}';
      document.body.appendChild(b);
    }
})();

(function() { // foldable
    var f = document.querySelectorAll('.fold');
    for (var i = 0; i < f.length; i++) {
      var s = document.createElement('div');
      s.className = 'foldable';
      s.innerHTML = '<input type="checkbox" id="fold-' + i + '" class="fold-check"></input>';
      if (f[i].getAttribute('alt')) {
        s.innerHTML += '<label for="fold-' + i + '" class="fold-title">' + '<span class="fold-icon"></span>' + f[i].getAttribute('alt') + '</label>';
      } else {
        s.innerHTML += '<label for="fold-' + i + '" class="fold-title">' + '<span class="fold-icon"></span>' + 'Click Here' + '</label>';
      }
      if (f[i].tagName === 'P') {
        s.innerHTML += '<div class="fold-content"><p>' + f[i].innerHTML + '</p></div>';
      } else {
        s.innerHTML += '<div class="fold-content">' + f[i].innerHTML + '</div>';
      }
      f[i].parentNode.insertBefore(s, f[i]);
      f[i].parentNode.removeChild(f[i]);
    }
})();
</script>
